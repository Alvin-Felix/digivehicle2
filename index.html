<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e40af">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="Indian Bank Field Inspection Tool">
    <link rel="manifest" href="manifest.json">
    <title>DigiLoan Master Ultimate</title>
    
    <style>
        :root {
            --primary: #1e40af; --secondary: #1e3a8a; --success: #15803d;
            --danger: #b91c1c; --bg: #f8fafc; --surface: #ffffff;
            --text: #0f172a; --border: #cbd5e1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }

        body {
            background-color: var(--bg); color: var(--text); margin: 0;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            position: fixed; width: 100%;
        }

        /* HEADER */
        header {
            background: var(--primary); color: white; 
            padding: calc(15px + env(safe-area-inset-top)) 20px 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100;
        }

        .progress-bar { height: 6px; background: #e2e8f0; width: 100%; }
        #prog-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.3s ease; }

        main { flex: 1; overflow-y: auto; padding: 20px; max-width: 700px; margin: 0 auto; width: 100%; padding-bottom: 150px; }

        /* CARDS */
        .field-box { 
            background: white; padding: 16px; border-radius: 12px; 
            border: 1px solid #e2e8f0; margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .section-h { 
            font-size: 1.1rem; color: var(--primary); font-weight: 800; 
            border-bottom: 3px solid #bfdbfe; padding-bottom: 10px; 
            margin-bottom: 25px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* NEW STYLES FOR CHECKLIST (USER REQUEST) */
        .section-header {
            background: #eff6ff; color: var(--primary); 
            padding: 12px; font-weight: 800; border-radius: 8px; 
            margin-top: 20px; margin-bottom: 10px; border-left: 5px solid var(--primary);
        }
        .checklist { list-style: none; padding: 0; margin: 0; }
        .checklist li { 
            background: white; border-bottom: 1px solid #e2e8f0; 
            padding: 12px 5px; display: flex; align-items: flex-start; gap: 10px; 
            font-size: 0.95rem; line-height: 1.4;
        }
        .checklist li:last-child { border-bottom: none; }
        .check-icon { font-weight: bold; color: var(--success); min-width: 25px; }

        /* LABELS & BUTTONS */
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        label { font-size: 0.85rem; font-weight: 700; color: #334155; text-transform: uppercase; }

        .help-trigger {
            background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe;
            width: 28px; height: 28px; border-radius: 50%; font-weight: bold;
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer;
        }

        input, select, textarea { 
            width: 100%; padding: 14px; font-size: 1rem; border: 2px solid var(--border); 
            border-radius: 10px; background: #f8fafc; transition: all 0.2s;
        }
        input:focus { border-color: var(--primary); outline: none; background: white; box-shadow: 0 0 0 4px #dbeafe; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }

        /* TOOLBAR */
        .tool-row { display: flex; gap: 10px; margin-top: 5px; }
        .tool-btn {
            flex: 1; border: none; padding: 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-mic { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .btn-speak { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .btn-scan { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .speaking-active { animation: pulse 1s infinite; background: #22c55e !important; color: white !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* POPUP SYSTEM (Fail-Safe) */
        #global-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9000; display: none;
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        }
        #global-popup {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 24px 24px 0 0;
            z-index: 9001; display: none; padding: 25px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .popup-close-btn {
            width: 100%; padding: 15px; background: #f1f5f9; color: #475569;
            border: none; border-radius: 12px; font-weight: bold; margin-top: 15px;
            font-size: 1rem; cursor: pointer;
        }

        /* NAVIGATION & DASHBOARD */
        .nav-footer { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            padding: 15px 20px calc(15px + env(safe-area-inset-bottom)); 
            display: flex; gap: 10px; border-top: 1px solid #e2e8f0; z-index: 500; 
        }
        .btn { border: none; border-radius: 12px; padding: 16px; font-weight: 700; cursor: pointer; flex: 1; font-size: 1rem; }
        .btn-next { background: var(--primary); color: white; }
        .btn-prev { background: #f1f5f9; color: #64748b; flex: 0 0 80px; }

        .dashboard { text-align: center; padding-top: 20px; }
        .start-circle { 
            width: 140px; height: 140px; border-radius: 50%; background: var(--primary); 
            color: white; border: 8px solid #dbeafe; font-weight: 800; font-size: 1.1rem;
            margin: 0 auto 20px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(30,64,175,0.3);
            cursor: pointer;
        }
        
        .record-item {
            background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .math-badge { background: #ecfccb; color: #365314; border: 1px solid #bef264; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div style="line-height:1.1">
        <div style="font-weight:900; font-size:1.2rem">DigiLoan Master</div>
        <div style="font-size:0.65rem; opacity:0.9; letter-spacing:1px">ENTERPRISE SOP SUITE</div>
    </div>
    <button onclick="app.toggleLang()" id="langBtn" style="background:rgba(255,255,255,0.2); border:1px solid white; color:white; border-radius:20px; padding:6px 14px; font-weight:bold; font-size:0.85rem; cursor:pointer;">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
</header>
<div class="progress-bar"><div id="prog-fill"></div></div>

<main id="app-root"></main>

<div id="global-backdrop" onclick="closePopup()"></div>
<div id="global-popup">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 id="pop-title" style="margin:0; color:var(--primary); font-size:1.3rem">Explanation</h3>
        <button onclick="closePopup()" style="background:var(--danger); color:white; border:none; width:36px; height:36px; border-radius:50%; font-weight:bold; cursor:pointer;">‚úï</button>
    </div>
    <div id="pop-text" style="font-size:1.1rem; color:#334155; margin-bottom:25px;"></div>
    
    <button class="btn" style="background:var(--success); color:white; width:100%" onclick="app.readPopup()">üîä READ ALOUD</button>
    <button class="popup-close-btn" onclick="closePopup()">CLOSE</button>
</div>

<div class="nav-footer" id="navFooter" style="display:none;">
    <button class="btn btn-prev" onclick="app.prev()" id="btnPrev">BACK</button>
    <button class="btn btn-next" onclick="app.next()" id="btnNext">NEXT</button>
</div>

<input type="file" id="scanInput" accept="image/*" style="display:none" onchange="app.processScan(this)">

<script>
    // --- GLOBAL SCOPE FUNCTIONS (Fail-Safe) ---
    window.closePopup = function() {
        window.speechSynthesis.cancel();
        document.getElementById('global-backdrop').style.display = 'none';
        document.getElementById('global-popup').style.display = 'none';
    };

    window.openPopup = function(text, title) {
        document.getElementById('pop-title').innerText = title;
        // Changed to innerHTML to render HTML tags in the checklist
        document.getElementById('pop-text').innerHTML = text;
        document.getElementById('global-backdrop').style.display = 'block';
        document.getElementById('global-popup').style.display = 'block';
    };

    // --- TRANSLATION MAP ---
    const optMap = {
        'YES': '‡ÆÜ‡ÆÆ‡Øç (Yes)', 'NO': '‡Æá‡Æ≤‡Øç‡Æ≤‡Øà (No)',
        'Online': '‡ÆÜ‡Æ©‡Øç‡Æ≤‡Øà‡Æ©‡Øç', 'Offline': '‡ÆÜ‡ÆÉ‡Æ™‡Øç‡Æ≤‡Øà‡Æ©‡Øç',
        'Married': '‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Æ£‡ÆÆ‡Øç ‡ÆÜ‡Æ©‡Æµ‡Æ∞‡Øç', 'Unmarried': '‡ÆÜ‡Æï‡Ææ‡Æ§‡Æµ‡Æ∞‡Øç',
        'General': '‡Æ™‡Øä‡Æ§‡ØÅ (General)', 'OBC': '‡Æ™‡Æø.‡Æö‡Æø (OBC)', 'SC': '‡Æé‡Æ∏‡Øç.‡Æö‡Æø (SC)', 'ST': '‡Æé‡Æ∏‡Øç.‡Æü‡Æø (ST)',
        'UG': '‡Æá‡Æ≥‡Æô‡Øç‡Æï‡Æ≤‡Øà (UG)', 'PG': '‡ÆÆ‡ØÅ‡Æ§‡ØÅ‡Æï‡Æ≤‡Øà (PG)', 'Professional': '‡Æ§‡Øä‡Æ¥‡Æø‡Æ≤‡Øç‡ÆÆ‡ØÅ‡Æ±‡Øà', 'Others': '‡ÆÆ‡Æ±‡Øç‡Æ±‡Æµ‡Øà',
        'Ancestral': '‡Æ™‡Æ∞‡ÆÆ‡Øç‡Æ™‡Æ∞‡Øà', 'Owned': '‡Æö‡Øä‡Æ®‡Øç‡Æ§‡ÆÆ‡Øç', 'Rented': '‡Æµ‡Ææ‡Æü‡Æï‡Øà',
        'Salaried': '‡ÆÆ‡Ææ‡Æ§ ‡Æö‡ÆÆ‡Øç‡Æ™‡Æ≥‡ÆÆ‡Øç', 'Self-Employed': '‡Æö‡ØÅ‡ÆØ‡Æ§‡Øä‡Æ¥‡Æø‡Æ≤‡Øç',
        '2 Wheeler': '2 ‡Æö‡Æï‡Øç‡Æï‡Æ∞‡ÆÆ‡Øç', '4 Wheeler': '4 ‡Æö‡Æï‡Øç‡Æï‡Æ∞‡ÆÆ‡Øç',
        'Fixed': '‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Ææ‡Æ©', 'Floating': '‡ÆÆ‡Ææ‡Æ±‡ØÅ‡ÆÆ‡Øç',
        'Home Branch': '‡Æ§‡Ææ‡ÆØ‡Øç ‡Æï‡Æø‡Æ≥‡Øà', 'Other Branch': '‡ÆÆ‡Æ±‡Øç‡Æ± ‡Æï‡Æø‡Æ≥‡Øà',
        'Movable': '‡ÆÖ‡Æö‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç', 'Immovable': '‡ÆÖ‡Æö‡Øà‡ÆØ‡Ææ',
        'Approve': '‡Æè‡Æ±‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ', 'Reject': '‡Æ®‡Æø‡Æ∞‡Ææ‡Æï‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ', 'Refer': '‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà'
    };

    // --- COMPLETE SOP SCHEMA ---
    const schema = [
        { id: 'AUTH', title_en: "Identity & Consent", title_ta: "‡ÆÖ‡Æü‡Øà‡ÆØ‡Ææ‡Æ≥‡ÆÆ‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æö‡ÆÆ‡Øç‡ÆÆ‡Æ§‡ÆÆ‡Øç", fields: [
            { id: 'app_mode', type: 'select', label_en: 'Mode', label_ta: '‡ÆÆ‡ØÅ‡Æ±‡Øà', opts: ['Online', 'Offline'] },
            { id: 'is_existing', type: 'select', label_en: 'Existing Customer?', label_ta: '‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Ææ?', opts: ['YES', 'NO'], info_en: "Does this person have an account?", info_ta: "‡Æá‡Æµ‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡Ææ?" },
            { id: 'cif', type: 'text', inputmode: 'numeric', label_en: 'SB A/c / CIF Number', label_ta: '‡Æö‡Æø‡Æê‡Æé‡ÆÉ‡Æ™‡Øç / ‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æ£‡Øç', canScan: true, info_en: "ID from Passbook.", info_ta: "‡Æµ‡Æô‡Øç‡Æï‡Æø ‡Æ™‡ØÅ‡Æ§‡Øç‡Æ§‡Æï‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æé‡Æ£‡Øç." },
            { id: 'otp', type: 'text', inputmode: 'numeric', maxlength: 6, label_en: 'OTP Consent', label_ta: '‡Æí‡Æü‡Æø‡Æ™‡Æø (‡Æö‡ÆÆ‡Øç‡ÆÆ‡Æ§‡ÆÆ‡Øç)', info_en: "6-digit code on mobile.", info_ta: "‡ÆÆ‡Øä‡Æ™‡Øà‡Æ≤‡Æø‡Æ≤‡Øç ‡Æµ‡Æ®‡Øç‡Æ§ 6 ‡Æá‡Æ≤‡Æï‡Øç‡Æï ‡Æé‡Æ£‡Øç." }
        ]},
        { id: 'PROFILE', title_en: "Personal Details", title_ta: "‡Æ§‡Æ©‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç", fields: [
            { id: 'fullname', type: 'text', label_en: 'Full Name', label_ta: '‡ÆÆ‡ØÅ‡Æ¥‡ØÅ ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç', canScan: true },
            { id: 'father', type: 'text', label_en: "Father's Name", label_ta: '‡Æ§‡Æ®‡Øç‡Æ§‡Øà ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç' },
            { id: 'mother', type: 'text', label_en: "Mother's Name", label_ta: '‡Æ§‡Ææ‡ÆØ‡Ææ‡Æ∞‡Øç ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç' },
            { id: 'dob', type: 'date', label_en: 'Date of Birth', label_ta: '‡Æ™‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æ§‡Øá‡Æ§‡Æø' },
            { id: 'aadhaar', type: 'text', maxlength: 12, inputmode: 'numeric', label_en: 'Aadhaar Number', label_ta: '‡ÆÜ‡Æ§‡Ææ‡Æ∞‡Øç ‡Æé‡Æ£‡Øç', canScan: true },
            { id: 'pan', type: 'text', label_en: 'PAN Number', label_ta: '‡Æ™‡Ææ‡Æ©‡Øç ‡Æé‡Æ£‡Øç', canScan: true },
            { id: 'marital', type: 'select', label_en: 'Marital Status', label_ta: '‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Æ£ ‡Æ®‡Æø‡Æ≤‡Øà', opts: ['Married', 'Unmarried'] },
            { id: 'dependents', type: 'number', label_en: 'Dependencies', label_ta: '‡Æö‡Ææ‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æµ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç' },
            { id: 'caste', type: 'select', label_en: 'Category', label_ta: '‡Æ™‡Æø‡Æ∞‡Æø‡Æµ‡ØÅ', opts: ['General', 'OBC', 'SC', 'ST'] },
            { id: 'edu', type: 'select', label_en: 'Education', label_ta: '‡Æï‡Æ≤‡Øç‡Æµ‡Æø', opts: ['UG', 'PG', 'Professional', 'Others'] }
        ]},
        { id: 'RESIDENCE', title_en: "Address", title_ta: "‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø", fields: [
            { id: 'stay_years', type: 'number', label_en: 'Years at Location', label_ta: '‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§ ‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ‡Æï‡Æ≥‡Øç' },
            { id: 'ownership', type: 'select', label_en: 'Ownership', label_ta: '‡Æâ‡Æ∞‡Æø‡ÆÆ‡Øà', opts: ['Ancestral', 'Owned', 'Rented'] },
            { id: 'curr_addr', type: 'textarea', label_en: 'Current Address', label_ta: '‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡Øà‡ÆØ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø' },
            { id: 'perm_addr', type: 'textarea', label_en: 'Permanent Address', label_ta: '‡Æ®‡Æø‡Æ∞‡Æ®‡Øç‡Æ§‡Æ∞ ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø', special: 'copy' }
        ]},
        { id: 'JOB', title_en: "Employment", title_ta: "‡Æµ‡Øá‡Æ≤‡Øà ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç", fields: [
            { id: 'emp_type', type: 'select', label_en: 'Job Type', label_ta: '‡Æµ‡Øá‡Æ≤‡Øà ‡Æµ‡Æï‡Øà', opts: ['Salaried', 'Self-Employed', 'Professional'] },
            { id: 'uan', type: 'text', label_en: 'UAN (PF Number)', label_ta: '‡ÆØ‡ØÅ‡Æè‡Æé‡Æ©‡Øç ‡Æé‡Æ£‡Øç', canScan: true, info_en: "PF Number from Salary Slip.", info_ta: "‡Æö‡ÆÆ‡Øç‡Æ™‡Æ≥ ‡Æ∞‡Æö‡ØÄ‡Æ§‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æ™‡Æø.‡Æé‡ÆÉ‡Æ™‡Øç ‡Æé‡Æ£‡Øç." },
            { id: 'emp_id', type: 'text', label_en: 'Employee ID', label_ta: '‡Æ™‡Æ£‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç ‡Æé‡Æ£‡Øç' },
            { id: 'emp_name', type: 'text', label_en: 'Employer Name', label_ta: '‡Æ®‡Æø‡Æ±‡ØÅ‡Æµ‡Æ© ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç' },
            { id: 'exp', type: 'number', label_en: 'Years Experience', label_ta: '‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Æµ‡ÆÆ‡Øç' },
            { id: 'org_addr', type: 'textarea', label_en: 'Work Address', label_ta: '‡Æµ‡Øá‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø' }
        ]},
        { id: 'FINANCE', title_en: "Financials", title_ta: "‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç", fields: [
            { id: 'gross', type: 'number', label_en: 'Gross Monthly Income', label_ta: '‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç', canScan: true, info_en: "Salary before cuts.", info_ta: "‡Æ™‡Æø‡Æü‡Æø‡Æ§‡Øç‡Æ§‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡ÆÆ‡ØÅ‡Æ©‡Øç ‡Æö‡ÆÆ‡Øç‡Æ™‡Æ≥‡ÆÆ‡Øç." },
            { id: 'deductions', type: 'number', label_en: 'Total Deductions', label_ta: '‡Æ™‡Æø‡Æü‡Æø‡Æ§‡Øç‡Æ§‡Æô‡Øç‡Æï‡Æ≥‡Øç', info_en: "Tax, PF, Insurance.", info_ta: "‡Æµ‡Æ∞‡Æø, ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ ‡Æ™‡Øã‡Æ©‡Øç‡Æ±‡Æµ‡Øà." },
            { id: 'emi', type: 'number', label_en: 'Existing EMIs', label_ta: '‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡ØÅ‡Æ≥‡Øç‡Æ≥ EMI', info_en: "Other loan payments.", info_ta: "‡ÆÆ‡Æ±‡Øç‡Æ± ‡Æï‡Æü‡Æ©‡Øç ‡Æ§‡Æµ‡Æ£‡Øà‡Æï‡Æ≥‡Øç." }
        ]},
        { id: 'LOAN', title_en: "Loan Request", title_ta: "‡Æï‡Æü‡Æ©‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç", fields: [
            { id: 'v_type', type: 'select', label_en: 'Vehicle Type', label_ta: '‡Æµ‡Ææ‡Æï‡Æ© ‡Æµ‡Æï‡Øà', opts: ['2 Wheeler', '4 Wheeler'] },
            { id: 'v_ex', type: 'number', label_en: 'Ex-Showroom Price', label_ta: '‡Æé‡Æï‡Øç‡Æ∏‡Øç-‡Æ∑‡Øã‡Æ∞‡ØÇ‡ÆÆ‡Øç ‡Æµ‡Æø‡Æ≤‡Øà' },
            { id: 'v_rto', type: 'number', label_en: 'RTO Charges', label_ta: 'RTO ‡Æï‡Æü‡Øç‡Æü‡Æ£‡ÆÆ‡Øç' },
            { id: 'v_ins', type: 'number', label_en: 'Insurance', label_ta: '‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ' },
            { id: 'margin_paid', type: 'number', label_en: 'Margin/Advance Paid', label_ta: '‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Æ£‡ÆÆ‡Øç' },
            { id: 'loan_req', type: 'number', label_en: 'Loan Required', label_ta: '‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æï‡Æü‡Æ©‡Øç' },
            { id: 'roi_type', type: 'select', label_en: 'ROI Type', label_ta: '‡Æµ‡Æü‡Øç‡Æü‡Æø ‡Æµ‡Æï‡Øà', opts: ['Fixed', 'Floating'] },
            { id: 'branch', type: 'select', label_en: 'Branch Selection', label_ta: '‡Æï‡Æø‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ', opts: ['Home Branch', 'Other Branch'] }
        ]},
        { id: 'ASSETS', title_en: "Assets & Check", title_ta: "‡Æö‡Øä‡Æ§‡Øç‡Æ§‡ØÅ & ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡ØÅ", fields: [
            { id: 'asset_type', type: 'select', label_en: 'Asset Type', label_ta: '‡Æö‡Øä‡Æ§‡Øç‡Æ§‡ØÅ ‡Æµ‡Æï‡Øà', opts: ['Movable', 'Immovable'] },
            { id: 'asset_desc', type: 'textarea', label_en: 'Asset Description', label_ta: '‡Æö‡Øä‡Æ§‡Øç‡Æ§‡ØÅ ‡Æµ‡Æø‡Æµ‡Æ∞‡ÆÆ‡Øç' },
            { id: 'penny', type: 'select', label_en: 'Dealer Penny Drop?', label_ta: '‡Æü‡ØÄ‡Æ≤‡Æ∞‡Øç ‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡ØÅ?', opts: ['YES', 'NO'], info_en: "Did you verify dealer A/c with ‚Çπ1?", info_ta: "‡Æü‡ØÄ‡Æ≤‡Æ∞‡Øç ‡Æï‡Æ£‡Æï‡Øç‡Æï‡Øà ‚Çπ1 ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æø ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ?" },
            { id: 'staff_rel', type: 'select', label_en: 'Staff Relation?', label_ta: '‡Æµ‡Æô‡Øç‡Æï‡Æø ‡Æä‡Æ¥‡Æø‡ÆØ‡Æ∞‡Øç ‡Æâ‡Æ±‡Æµ‡Ææ?', opts: ['NO', 'YES'] },
            { id: 'person_met', type: 'text', label_en: 'Person Met', label_ta: '‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ§‡Øç‡Æ§ ‡Æ®‡Æ™‡Æ∞‡Øç' },
            { id: 'rec', type: 'select', label_en: 'Recommendation', label_ta: '‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà', opts: ['Approve', 'Reject', 'Refer'] }
        ]}
    ];

    const labelMap = { 
        cif: "CIF/Account", uan: "UAN No", gross: "Gross Income", loan_req: "Loan Needed", 
        v_ex: "Vehicle Price", emi: "Existing EMI"
    };

    const app = {
        lang: 'ta', step: -1, data: {}, records: [], scanId: null,

        init: function() {
            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
            }
            const s = localStorage.getItem('DigiLoan_Ultimate_V2');
            if(s) this.records = JSON.parse(s);
            this.updateLang();
            this.render();
        },

        updateLang: function() {
            document.getElementById('langBtn').innerText = this.lang === 'ta' ? 'English' : '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç';
        },

        toggleLang: function() {
            this.lang = this.lang === 'ta' ? 'en' : 'ta';
            this.updateLang();
            if(this.step >= 0) this.renderStep(); else this.render();
        },

        // New function to display the Guide/Checklist
        showGuide: function() {
            const content = `
                <div class="section-header">Next Steps: Branch Procedure</div>
                <ul class="checklist">
                    <li><span class="check-icon">1.</span> <strong>Visit Branch:</strong> Contact selected branch with Ref No.</li>
                    <li><span class="check-icon">2.</span> <strong>Field Investigation:</strong> Official will verify Residence/Office.</li>
                    <li><span class="check-icon">3.</span> <strong>Dealer Check:</strong> Branch validates dealer bank account (Penny Drop).</li>
                    <li><span class="check-icon">4.</span> <strong>Sanction:</strong> Branch Manager approves loan.</li>
                    <li><span class="check-icon">5.</span> <strong>Acceptance:</strong> Login to portal to "Accept Offer".</li>
                    <li><span class="check-icon">6.</span> <strong>Disbursement:</strong> Bank pays directly to Dealer via RTGS.</li>
                </ul>

                <div class="section-header">Mandatory Documents Required</div>
                <ul class="checklist">
                    <li><span class="check-icon">üìÑ</span> <strong>KYC:</strong> PAN Card & Aadhaar Card.</li>
                    <li><span class="check-icon">üì∑</span> <strong>Photo:</strong> Recent passport size photo.</li>
                    <li><span class="check-icon">üí∞</span> <strong>Income:</strong> Salary Slips (3 months) / ITR (2 years).</li>
                    <li><span class="check-icon">üöó</span> <strong>Vehicle:</strong> Dealer Quotation (Proforma Invoice).</li>
                    <li><span class="check-icon">üè¶</span> <strong>Bank:</strong> Statement showing salary credit.</li>
                </ul>
            `;
            window.openPopup(content, "Process Guide & Documents");
        },

        render: function() {
            this.step = -1;
            document.getElementById('navFooter').style.display = 'none';
            document.getElementById('prog-fill').style.width = '0%';
            const isTa = this.lang === 'ta';
            
            const list = this.records.length === 0 ? `<p style="color:#64748b">${isTa?'‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà':'No records.'}</p>` : 
                this.records.slice().reverse().map((r,i)=>`
                <div class="record-item">
                    <div style="flex:1"><b>${r.fullname||r.cif||'Case'}</b><br><small>${r.timestamp}</small></div>
                    <button class="tool-btn" style="background:#2b5797; color:white; flex:0" onclick="app.exportWord(${this.records.length-1-i})">WORD</button>
                </div>`).join('');

            document.getElementById('app-root').innerHTML = `
                <div class="dashboard">
                    <button class="start-circle" onclick="app.start()">
                        <div style="font-size:2rem; margin-bottom:5px;">+</div>
                        <div>${isTa?'‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÜ‡ÆØ‡Øç‡Æµ‡ØÅ':'NEW CASE'}</div>
                    </button>
                    
                    <button class="btn" style="background:white; color:var(--primary); border:2px solid #bfdbfe; margin-bottom:30px; box-shadow:0 2px 5px rgba(0,0,0,0.05);" onclick="app.showGuide()">
                        üìñ ${isTa?'‡Æö‡ØÜ‡ÆØ‡Æ≤‡Øç‡ÆÆ‡ØÅ‡Æ±‡Øà ‡Æµ‡Æ¥‡Æø‡Æï‡Ææ‡Æü‡Øç‡Æü‡Æø':'PROCESS GUIDE'}
                    </button>

                    <div style="text-align:left">
                        <h3 style="color:var(--primary); border-bottom:2px solid #e2e8f0; padding-bottom:5px;">${isTa?'‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ':'HISTORY'}</h3>
                        ${list}
                    </div>
                </div>`;
        },

        renderStep: function() {
            const s = schema[this.step];
            const isTa = this.lang === 'ta';
            document.getElementById('navFooter').style.display = 'flex';
            document.getElementById('prog-fill').style.width = ((this.step+1)/schema.length)*100 + '%';
            document.getElementById('btnPrev').innerText = isTa ? "‡Æ™‡Æø‡Æ©‡Øç‡Æ©‡Ææ‡Æ≤‡Øç" : "BACK";
            document.getElementById('btnNext').innerText = (this.step === schema.length-1) ? (isTa ? "‡ÆÆ‡ØÅ‡Æü‡Æø" : "FINISH") : (isTa ? "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ" : "NEXT");

            let h = `<div class="section-h">${isTa ? s.title_ta : s.title_en}</div>`;
            
            // LIVE MATH LOGIC
            if(s.id === 'FINANCE') {
                const net = Math.max(0, (Number(this.data.gross)||0) - (Number(this.data.deductions)||0) - (Number(this.data.emi)||0));
                h += `<div class="math-badge">üí∞ ${isTa?'‡Æ®‡Æø‡Æï‡Æ∞ ‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç':'Net Disposable'}: ‚Çπ ${net.toLocaleString('en-IN')}</div>`;
            }
            if(s.id === 'LOAN') {
                const total = (Number(this.data.v_ex)||0) + (Number(this.data.v_rto)||0) + (Number(this.data.v_ins)||0);
                const margin = Math.max(0, total - (Number(this.data.loan_req)||0) - (Number(this.data.margin_paid)||0));
                h += `<div class="math-badge">üöò ${isTa?'‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æµ‡Æø‡Æ≤‡Øà':'On-Road'}: ‚Çπ ${total.toLocaleString('en-IN')}<br>${isTa?'‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æú‡Æø‡Æ©‡Øç':'Pending Margin'}: ‚Çπ ${margin.toLocaleString('en-IN')}</div>`;
            }

            h += s.fields.map(f => `
                <div class="field-box">
                    <div class="label-row">
                        <label>${isTa ? f.label_ta : f.label_en}</label>
                        ${f.info_en ? `<button class="help-trigger" onclick="window.openPopup('${isTa?f.info_ta:f.info_en}','${isTa?'‡Æµ‡Æø‡Æ≥‡Æï‡Øç‡Æï‡ÆÆ‡Øç':'Explanation'}')">?</button>` : ''}
                    </div>
                    
                    ${f.type === 'select' ? 
                        `<select onchange="app.save('${f.id}', this.value)">
                            <option value="">${isTa ? '‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ...' : 'Select...'}</option>
                            ${f.opts.map(o=>`<option value="${o}" ${this.data[f.id]===o?'selected':''}>${isTa ? (optMap[o] || o) : o}</option>`).join('')}
                        </select>` :
                        (f.type === 'textarea' ? `<textarea rows="2" oninput="app.save('${f.id}', this.value)">${this.data[f.id]||''}</textarea>` :
                        `<input type="${f.type}" value="${this.data[f.id]||''}" oninput="app.save('${f.id}', this.value)" inputmode="${f.inputmode||'text'}">`)
                    }

                    <div class="tool-row">
                        <button class="tool-btn btn-speak" onclick="app.speak('${isTa ? f.label_ta : f.label_en}', this)">üîä Speak</button>
                        <button class="tool-btn btn-mic" onclick="app.listen('${f.id}')">üé§ Input</button>
                        ${f.canScan ? `<button class="tool-btn btn-scan" onclick="app.triggerScan('${f.id}')">üì∑ Scan</button>` : ''}
                        ${f.special === 'copy' ? `<button class="tool-btn" style="background:#e0f2fe; color:#0369a1" onclick="app.copyAddr('${f.id}')">üìã Copy</button>` : ''}
                    </div>
                </div>`).join('');

            document.getElementById('app-root').innerHTML = h;
        },

        start: function() { this.step = 0; this.data = { timestamp: new Date().toLocaleString() }; this.renderStep(); },
        
        next: function() { 
            const f = schema[this.step].fields;
            if(f.some(x => !this.data[x.id] && x.id !== 'asset_desc' && x.id !== 'perm_addr')) {
                alert(this.lang==='ta' ? "‡ÆÖ‡Æ©‡Øà‡Æ§‡Øç‡Æ§‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ∞‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç" : "Fill required fields"); return;
            }
            if(this.step < schema.length-1) { this.step++; this.renderStep(); } else { this.finish(); } 
        },

        prev: function() { if(this.step > 0) { this.step--; this.renderStep(); } else { this.render(); } },
        save: function(k, v) { this.data[k] = v; if(['gross','deductions','emi','v_ex','v_rto','v_ins','loan_req','margin_paid'].includes(k)) this.renderStep(); },
        
        copyAddr: function(id) { this.data[id] = this.data.curr_addr || ''; this.renderStep(); },

        triggerScan: function(id) { this.scanId = id; document.getElementById('scanInput').click(); },
        
        processScan: function(el) {
            if(el.files[0]) {
                // Simulated OCR
                const val = this.scanId==='cif'?'89440112' : (this.scanId==='gross'?'52000':'OCR DATA');
                this.data[this.scanId] = val;
                this.renderStep();
                alert("Data Scanned!");
            }
        },

        speak: function(t, btn) {
            if(speechSynthesis.speaking) speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = this.lang === 'ta' ? 'ta-IN' : 'en-IN';
            if(btn) { btn.classList.add('speaking-active'); u.onend = () => btn.classList.remove('speaking-active'); }
            window.speechSynthesis.speak(u);
        },

        readPopup: function() { this.speak(document.getElementById('pop-text').innerText); },

        listen: function(id) {
            const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Rec) return alert("Use Chrome");
            const r = new Rec(); r.lang = this.lang === 'ta' ? 'ta-IN' : 'en-IN';
            r.onresult = e => { this.data[id] = e.results[0][0].transcript; this.renderStep(); };
            r.start();
        },
finish: async function() {
            // Security: Strip OTP
            const safe = {...this.data}; delete safe.otp;
            
            // Integrity Hashing
            const str = JSON.stringify(safe);
            const buf = new TextEncoder().encode(str);
            const hash = await crypto.subtle.digest('SHA-256', buf);
            safe.hash = Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('').substring(0,12);

            this.records.push(safe);
            localStorage.setItem('DigiLoan_Ultimate_V2', JSON.stringify(this.records));
            this.render();
        },
        exportWord: function(i) {
            const rec = this.records[i];
            const isTa = this.lang === 'ta';
            let h = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset="utf-8"></head><body><h1>Indian Bank Credit Appraisal</h1><p>Date: ${rec.timestamp}</p><p>Integrity: ${rec.hash}</p><table border="1" style="width:100%;border-collapse:collapse">`;
            schema.forEach(s => {
                h += `<tr><td colspan="2" style="background:#eee;font-weight:bold;padding:5px">${isTa?s.title_ta:s.title_en}</td></tr>`;
                s.fields.forEach(f => h += `<tr><td width="40%">${isTa?f.label_ta:f.label_en}</td><td>${rec[f.id]||'--'}</td></tr>`);
            });
            h += `</table><br><div style="border:2px solid black;padding:10px"><b>VERIFICATION:</b> Penny Drop Checked? ${rec.penny||'NO'} | Staff Rel? ${rec.staff_rel||'NO'}</div></body></html>`;
            const b = new Blob(['\ufeff', h], { type: 'application/msword' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `IB_CAM_${i}.doc`; a.click();
        }
    };

    window.onload = () => app.init();
</script>
</body>
</html>
